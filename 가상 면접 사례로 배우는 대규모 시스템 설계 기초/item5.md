# item5. 안정 해시 설계
수평적 규모 확장성을 달성하기 위해 요청 또는 데이터를 서버에 균등하게 나누는 기술

## 해시 키 재배치 문제
N개의 서버에 부하를 균등하게 나누는 보편적 방법
serverIndex = hash(key) % N

서버 풀의 크기가 고정되어 있고, 데이터 분포가 균등할 땐 정상 동작
하지만, 서버가 추가되거나 기존 서버가 삭제되면 문제를 일으킴.
- 장애가 발생한 서버에 보관되어 있는 키 뿐만 아니라 대부분의 키가 재분배 되고, 캐시 클라이언트가 엉뚱한 서버에 접속하게 되어 대규모 캐시 미스 발생

## 안정 해시
해시 테이블 크기가 조정 될 때, 평균적으로 k/n개의 키만 재배치하는 해시 기술
- k: 키의 수, n: 슬롯의 수
- 대부분 전통적 해시 테이블은 슬록의 수가 바뀌면 거의 대부분 키를 재배치

### 해시 공간과 해시 링
해시 공간을 구부려 접어 처음과 끝이 만나게 하는 해시 링
### 해시 서버
해시 함수 f를 사용하면, 서버 ip나 이름을 해시 링 위의 어떤 위치에 대응시킬 수 있다.
### 해시 키
해시 키 또한 서버처럼 해시 링 위의 어느 지점에 배치할 수 있다.

### 서버 조회
어떤 키가 저장되는 서버는, 키의 위치로부터 시계 방향으로 링을 탐색해 만나는 첫 번째 서버
### 서버 추가
서버를 추가하더라도, 키 가운데 일부만 재배치 하면 된다.
### 서버 제거
서버 제거 또한, 키 가운데 일부만 재배치 된다.

## 기본 구현법의 두가지 문제
기본 절차
- 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 배치
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버

문제점
1. 서버가 추가되거나, 삭제되는 상황을 감안하면 파티션(인접한 서버 사이의 해시공간)의 크기가 균등하게 유지하는 게 불가능
2. 키의 균등 분포를 달성하기 어려움

해결 기법
가상 노드 또는 복제라 불리는 기법

## 가상 노드
실제 노드 또는 서버를 가리키는 노드로, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있음
가상 노드의 개수를 늘려, 표준 편차가 작아서, 데이터가 고르게 분포되어 키의 분포도 점점 균등해 짐
다만, 가상 노드 데이터를 저장할 공간도 필요해짐

## 재배치할 키 결정

### 마무리
안정 해시의 이점
- 서버가 추가되거나 삭제될 때, 재배치되는 키의 수가 최소화 된다.
- 데이터가 보다 균당하게 분포하게 되므로, 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟 키 문제를 줄이고, 특정한 햐드에 대한 접근이 지나치게 빈번하면 서버 과부하 문제가 생길 수 있지만, 그 가능성을 줄인다.
