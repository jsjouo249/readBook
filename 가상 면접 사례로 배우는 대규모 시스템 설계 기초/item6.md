# item6. 키-값 저장소 설계
키-값 저장소 - 키-값 데이터베이스라고도 불리는 비 관계형 데이터 베이스
- 키는 유일
- 값은 오직 키를 통해서만 접근
- 대표적
  - dynamoDB
  - memcached
  - redis

## 문제 이해 및 설계 범위 확정
설계 예시)
- 키-값 쌍의 크기는 10KB 이하
- 큰 데이터 저장 가능
- 높은 가용성 = 장애가 있더라도, 빨리 응답
- 높은 규모 확장성 = 트래픽 양에 따라 자동적으로 서버 증설/삭제 가능
- 데이터 일관성 수준은 조정 가능
- 응답 지연시간은 짧음

## 단일 서버 키-값 저장소
직관적인 방법 -> 키-값 쌍 전부를 메모리에 해시 테이블로 저장
- 빠른 속도 보장
- 메모리 안에 두는 것 불가능
- 개선책
  - 데이터 압축(compresion)
  - 자주 쓰이는 데이터만 메모리에 두고, 나머지는 디스크 저장

## 분산 키-값 저장소
분산 해시 테이블이라고도 불리며, CAP정리를 이해해야 함
- 일관성(Consistency)
  - 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이 언제나 같은 데이터 확인
- 가용성(Availability)
  - 클라이언트는 일부 노드에 장애가 발생하더라도, 항상 응답 받음
- 파티션 내성(Partition Tolerance)
  - 네트워크 장애로 인해 노드 간 통신이 불가능해도, 시스템은 계속 작동

### 시스템
- CP 시스템: 가용성을 희생하여, 일관성과 파티션 내성 지원
- AP 시스템: 일관성을 희생하여, 가용성과 파티션 내성 지원
- CA 시스템: 파티션 내성을 희생하여, 일관성과 가용성을 지원하지만, 분산 시스템은 반드시 파티션 내셩을 희생하면 안되서, 실제로는 없음

## 이상적 상태
이상적 환경이라면, 네트워크의 장애는 없으므로, 데이터 일관성과 가용성도 만족

## 실세계의 분산 시스템
분산 키-값 저장소를 만들 때는, 그 요구사항에 맞도록 CAP 정리를 적용해야 함

## 시스템 컴포넌트
- 데이터 파티션
  - 데이터를 작은 파티션들로 분할한 다음, 여러 서버에 저장
  - 고려할 점 - 안정 해시
    - 데이터를 여러 서버에 고르게 분산할 수 있는가
    - 노드가 추가되거나 삭제될 때 데이터의 이동을 최소화할 수 있는가
  - 안정 해시를 사용 시 장점.
    - 규모 확장 자동화
    - 다양성: 서버의 용량에 맞게 가상 노드의 수 조정 가능
- 데이터 다중화
  - 데이터를 N개 서버에 비동기적으로 다중화
- 데이터 일관성
  - 여러 노드에 다중화된 데이터는 적절히 동기화 되어야 함
  - 관계 정의
    - N = 사본 개수
    - W = 쓰기 연산이 성공하기 위해 필요한 사본 수
    - R = 읽기 연산이 성공하기 위해 필요한 사본 수
  - 서버 정의
      - R = 1, W = N: 빠른 읽기 연산에 최적화 된 시스템
      - W = 1, R = N: 빠른 쓰기 연산에 최적화 된 시스템
      - W + R > N: 강한 일관성을 보장하는 시스템(N = 3, W = R = 2)
      - W + R <= N: 약한 일관성을 보장하는 시스템
  - 일관성 모델
    - 강한 일관성: 모든 읽기 연산은 가장 최근에 갱신된 결과 반환
    - 약한 일관성: 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수 있다.
    - 최종 일관성: 갱신 결과가 결국 모든 사본에 반영
  - 비 일관성 해소 기법: 데이터 버저닝
    - 버저닝: 데이터 변경 시, 해당 데이터의 새로운 버전
    - 벡터시계
      - 충돌된 버저닝을 보완하기 위해 나온 시스템
      - [서버, 버전]의 순서쌍으로 나타냄
        - D([S1, v1],[S2, v2])
  - 장애 처리
    - 장애를 어떻게 처리할지 중요
      - 장애 감지
        - 두 대 이상의 서버가 똑같이 서버 A의 장애를 보고해야, 실제로 장애 발생했다고 간주
        - 가십 프로토콜 같은 분산형 장애 감지 솔루션
          - 각 노드는 주기적으로 자신의 박동 카운터 증가
          - 무작위로 선정된 노드들에게 자기 박동 카운터 전달
          - 카운터 받은 노드는 최신 값으로 갱신
          - 카운터 값이 일정 시간동안 갱신되지 않으면, 해당 노드는 장애로 간주
  - 일시적 장애 처리
    - 엄격한 정족수: 서버 정상 전까지 읽기와 쓰기 연산 금지
    - 느슨한 정족수: 장애 서버 무시하고, 나머지 서버에 읽기와 쓰기 연산 수행
  - 영구 장애 처리
    - 백업은 주기적으로 수행사본들을 비교하여, 최신버전으로 갱신함
  - 데이터 센터 장애 처리
    - 여러 데이터 센터에 다중화

## 마무리
| 목표 / 문제             | 기술                       |
|---------------------|--------------------------|
| 대규모 데이터 저장          | 안정 해시를 사용해 서버들에 부하 분산    |
| 읽기 연산에 대한 높은 가용성 보장 | 데이터를 여러 데이터센터에 다중화       |
| 쓰기 연산에 대한 높은 가용성 보장 | 버저닝 및 벡터 시계를 사용한 충돌 해소   |
| 데이터 파티션             | 안정 해시                    |
| 점진적 규모 확장성          | 안정 해시                    |
| 다양성(heterogeneity)  | 안정 해시                    |
| 조절 가능한 데이터 일관성      | 정족수 합의                   |
| 일시적 장애 처리           | 느슨한 정족수 프로토콜과 단서 후 임시 위탁 |
| 영구적 장애 처리           | 머클 트리                    |
| 데이터 센터 장애 대응        | 여러 데이터 센터에 걸친 다중화        |

    
